<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- WhatsApp / Open Graph Meta Tags -->
    <meta property="og:title" content="Guest Access Pass - Your Residence">
    <meta property="og:description" content="You've been granted special access to control the gate and garage">
    <meta property="og:image" content="https://raw.githubusercontent.com/twitter/twemoji/master/assets/72x72/1f3ab.png">
    <meta property="og:type" content="website">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Guest Access Pass">
    <meta name="twitter:description" content="You've been granted special access">

    <!-- Apple Mobile Web App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a0f00">

    <title>Guest Access Pass</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        display: ['Cormorant Garamond', 'serif'],
                        sans: ['Montserrat', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        gold: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --sat: env(safe-area-inset-top, 0px);
            --sab: env(safe-area-inset-bottom, 0px);
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(145deg, #0f0805 0%, #1a0f05 50%, #0d0a05 100%);
            min-height: 100vh;
            min-height: 100dvh;
            padding-top: var(--sat);
            padding-bottom: var(--sab);
        }

        .ticket-container {
            perspective: 1000px;
        }

        .golden-ticket {
            background: linear-gradient(145deg,
                #f59e0b 0%,
                #fbbf24 15%,
                #fef3c7 30%,
                #fcd34d 45%,
                #fbbf24 60%,
                #f59e0b 75%,
                #d97706 100%);
            position: relative;
            transform-style: preserve-3d;
            animation: ticketFloat 5s ease-in-out infinite;
            box-shadow:
                0 30px 60px -15px rgba(245, 158, 11, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.2) inset,
                0 0 80px rgba(245, 158, 11, 0.15);
        }

        .golden-ticket::before {
            content: '';
            position: absolute;
            inset: 4px;
            background: linear-gradient(160deg,
                #fef3c7 0%,
                #fde68a 25%,
                #fef3c7 45%,
                #fde68a 65%,
                #fef3c7 85%,
                #fde68a 100%);
            border-radius: 22px;
            z-index: 0;
        }

        .ticket-content {
            position: relative;
            z-index: 1;
        }

        .ticket-perforations {
            position: absolute;
            left: 22%;
            top: 0;
            bottom: 0;
            width: 3px;
            background: repeating-linear-gradient(
                to bottom,
                transparent 0px,
                transparent 10px,
                #92400e 10px,
                #92400e 20px
            );
            opacity: 0.5;
            z-index: 5;
        }

        .stub-section {
            position: relative;
            z-index: 1;
        }

        @keyframes ticketFloat {
            0%, 100% { transform: translateY(0) rotateX(0deg) rotateY(0deg); }
            25% { transform: translateY(-10px) rotateX(2deg) rotateY(-1.5deg); }
            50% { transform: translateY(-5px) rotateX(0deg) rotateY(0deg); }
            75% { transform: translateY(-8px) rotateX(-1deg) rotateY(1deg); }
        }

        .shimmer {
            position: absolute;
            inset: 0;
            background: linear-gradient(
                110deg,
                transparent 0%,
                transparent 35%,
                rgba(255,255,255,0.6) 45%,
                rgba(255,255,255,0.8) 50%,
                rgba(255,255,255,0.6) 55%,
                transparent 65%,
                transparent 100%
            );
            background-size: 300% 100%;
            animation: shimmer 5s infinite;
            border-radius: 26px;
            pointer-events: none;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .guest-name {
            font-family: 'Cormorant Garamond', serif;
            font-weight: 600;
            letter-spacing: 0.02em;
            line-height: 1.1;
        }

        .residence-label {
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            letter-spacing: 0.3em;
            text-transform: uppercase;
        }

        .control-button {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.03) 100%);
            border: 1px solid rgba(255,255,255,0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 88px;
        }

        .control-button:hover {
            background: rgba(255,255,255,0.12);
            border-color: rgba(255,255,255,0.25);
            transform: translateY(-2px);
        }

        .control-button:active {
            transform: scale(0.98) translateY(0);
            background: rgba(255,255,255,0.15);
        }

        .control-button.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .control-button.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3) 0%, rgba(16, 185, 129, 0.1) 100%);
            border-color: rgba(16, 185, 129, 0.5);
        }

        .success-pulse {
            animation: successPulse 0.8s ease-out;
        }

        @keyframes successPulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 30px rgba(16, 185, 129, 0); }
        }

        .loading-spinner {
            width: 26px;
            height: 26px;
            border: 3px solid rgba(255,255,255,0.15);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .ornament {
            position: absolute;
            width: 12px;
            height: 12px;
            opacity: 0.6;
        }

        .ornament svg {
            width: 100%;
            height: 100%;
            fill: #92400e;
        }

        .validity-badge {
            background: linear-gradient(135deg, rgba(146, 64, 14, 0.15) 0%, rgba(146, 64, 14, 0.05) 100%);
            border: 1px solid rgba(146, 64, 14, 0.3);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <!-- Ambient Background -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute -top-40 -right-40 w-96 h-96 bg-amber-600/20 rounded-full blur-[120px]"></div>
        <div class="absolute -bottom-40 -left-40 w-96 h-96 bg-orange-600/15 rounded-full blur-[120px]"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-72 h-72 bg-yellow-600/10 rounded-full blur-[100px]"></div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="text-center relative z-10">
        <div class="w-16 h-16 border-4 border-amber-500/30 border-t-amber-500 rounded-full animate-spin mx-auto mb-6"></div>
        <div class="text-amber-400 font-medium text-lg">Validating your pass...</div>
        <div class="text-amber-400/50 text-sm mt-2">Please wait</div>
    </div>

    <!-- Invalid Pass State -->
    <div id="invalidState" class="hidden text-center max-w-sm mx-auto relative z-10">
        <div class="w-28 h-28 mx-auto mb-8 rounded-full bg-gradient-to-br from-red-500/20 to-red-600/10 border border-red-500/30 flex items-center justify-center">
            <svg class="w-14 h-14 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                      d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
        </div>
        <h1 class="text-3xl font-semibold text-white mb-4">Access Denied</h1>
        <p id="invalidReason" class="text-white/60 text-base leading-relaxed px-4">This pass is invalid or has expired.</p>
        <p class="text-white/30 text-sm mt-6">Please contact the homeowner for a new pass.</p>
    </div>

    <!-- Valid Pass State - Golden Ticket -->
    <div id="validState" class="hidden ticket-container w-full max-w-md mx-auto relative z-10">
        <!-- The Golden Ticket -->
        <div class="golden-ticket rounded-3xl relative overflow-hidden">
            <!-- Corner Ornaments (on main ticket area only) -->
            <div class="ornament" style="top: 20px; right: 20px;">
                <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
            </div>
            <div class="ornament" style="bottom: 20px; right: 20px;">
                <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
            </div>

            <!-- Perforations -->
            <div class="ticket-perforations"></div>

            <!-- Two-column layout: Stub (left) | Main (right) -->
            <div class="flex">
                <!-- LEFT STUB - Guest Name Only -->
                <div class="stub-section w-[22%] py-8 px-2 flex flex-col items-center justify-center relative">
                    <div class="ornament" style="top: 12px; left: 12px;">
                        <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                    </div>
                    <div class="ornament" style="bottom: 12px; left: 12px;">
                        <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                    </div>
                    <!-- Rotated guest name for classic stub look -->
                    <div class="transform -rotate-90 whitespace-nowrap">
                        <div id="guestName" class="guest-name text-2xl text-amber-900 font-bold tracking-wide">Guest</div>
                    </div>
                    <div class="absolute bottom-3 left-1/2 -translate-x-1/2">
                        <div class="text-[8px] text-amber-700/50 uppercase tracking-widest">Guest</div>
                    </div>
                </div>

                <!-- RIGHT MAIN AREA - All ticket content -->
                <div class="ticket-content flex-1 py-6 pr-6 pl-4">
                    <!-- Ticket Header -->
                    <div class="text-center mb-4">
                        <div class="residence-label text-amber-800/70 text-[10px] mb-1">Your Residence</div>
                        <div class="font-display text-3xl font-bold text-amber-900 tracking-wide">GOLDEN TICKET</div>
                        <div class="text-amber-700/60 text-[10px] mt-1 font-medium uppercase tracking-widest">Exclusive Guest Access</div>
                    </div>

                    <!-- Decorative Line -->
                    <div class="flex items-center gap-2 mb-4">
                        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-amber-700/30 to-transparent"></div>
                        <svg class="w-3 h-3 text-amber-700/40" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-amber-700/30 to-transparent"></div>
                    </div>

                    <!-- Guest Info Card -->
                    <div class="bg-gradient-to-br from-amber-100/50 to-amber-200/30 rounded-xl p-4 border border-amber-400/40">
                        <div class="text-amber-700/60 text-[9px] uppercase tracking-[0.15em] font-semibold mb-1">Access granted to</div>
                        <div id="guestNameDisplay" class="guest-name text-2xl text-amber-900 mb-3">Guest</div>

                        <!-- Validity Badge -->
                        <div class="validity-badge rounded-lg px-3 py-2 mb-3">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-amber-800/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span id="validityPeriod" class="text-amber-900 text-xs font-medium">Valid until: --</span>
                            </div>
                        </div>

                        <!-- Permissions -->
                        <div class="flex items-center justify-center gap-2">
                            <div id="permissionsDisplay" class="flex items-center gap-2">
                                <!-- Permissions badges inserted by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Pass ID at bottom -->
                    <div class="text-center mt-3">
                        <div class="text-[9px] text-amber-700/40 uppercase tracking-wider">
                            ID: <span id="passId" class="font-mono">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shimmer overlay -->
            <div class="shimmer"></div>
        </div>

        <!-- Control Buttons (below ticket) -->
        <div class="mt-8 space-y-4">
            <!-- Gate Button -->
            <button id="gateBtn" class="control-button w-full py-5 px-6 rounded-2xl flex items-center gap-5" style="display: none;">
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-500/40 to-purple-600/20 border border-purple-400/40 flex items-center justify-center flex-shrink-0">
                    <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/>
                    </svg>
                </div>
                <div class="text-left flex-1">
                    <div class="text-xl font-semibold text-white">Open Gate</div>
                    <div class="text-sm text-white/50 mt-0.5">Front entrance gate</div>
                </div>
                <div id="gateStatus" class="flex-shrink-0">
                    <svg class="w-6 h-6 text-white/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </div>
            </button>

            <!-- Garage Button -->
            <button id="garageBtn" class="control-button w-full py-5 px-6 rounded-2xl flex items-center gap-5" style="display: none;">
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500/40 to-blue-600/20 border border-blue-400/40 flex items-center justify-center flex-shrink-0">
                    <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                </div>
                <div class="text-left flex-1">
                    <div class="text-xl font-semibold text-white">Open Garage</div>
                    <div class="text-sm text-white/50 mt-0.5">Garage door</div>
                </div>
                <div id="garageStatus" class="flex-shrink-0">
                    <svg class="w-6 h-6 text-white/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </div>
            </button>
        </div>

        <!-- Footer hint -->
        <div class="text-center mt-8">
            <div class="text-white/20 text-xs">
                Tap a button above to activate
            </div>
        </div>
    </div>

    <script>
        // Guest Access Page Logic
        const WEBHOOK_URL = '/api/webhook/guest_pass_validate';

        let passData = null;

        async function init() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');

            if (!token) {
                showInvalid('No access token provided in the URL.');
                return;
            }

            try {
                // Decode and parse token
                passData = parseToken(token);

                // Validate locally first
                const now = Math.floor(Date.now() / 1000);

                if (passData.validUntil && passData.validUntil < now) {
                    showInvalid('This pass has expired. Please request a new one from the homeowner.');
                    return;
                }

                if (passData.validFrom && passData.validFrom > now) {
                    const validFromDate = new Date(passData.validFrom * 1000);
                    const options = { weekday: 'long', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit' };
                    showInvalid(`This pass is not yet valid. It becomes active on ${validFromDate.toLocaleDateString('en-US', options)}.`);
                    return;
                }

                // Show valid state
                showValid(passData);

            } catch (e) {
                console.error('Token parse error:', e);
                showInvalid('Invalid or corrupted access pass. Please request a new one.');
            }
        }

        function parseToken(token) {
            // Decode URL-safe Base64
            let base64 = token.replace(/-/g, '+').replace(/_/g, '/');
            // Add padding if needed
            while (base64.length % 4) {
                base64 += '=';
            }
            const decoded = atob(base64);
            return JSON.parse(decoded);
        }

        function showValid(data) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('validState').classList.remove('hidden');

            // Guest name - set both stub and main display
            const name = data.name || 'Guest';
            document.getElementById('guestName').textContent = name;
            document.getElementById('guestNameDisplay').textContent = name;

            // Pass ID (truncated for display)
            document.getElementById('passId').textContent = data.id?.substring(0, 12) || '--';

            // Validity period with friendly formatting
            if (data.validUntil) {
                const validUntil = new Date(data.validUntil * 1000);
                const now = new Date();
                const diffHours = Math.round((validUntil - now) / (1000 * 60 * 60));
                const diffDays = Math.round(diffHours / 24);

                let validityText;
                if (diffHours < 0) {
                    validityText = 'Expired';
                } else if (diffHours < 1) {
                    validityText = 'Valid for less than an hour';
                } else if (diffHours < 24) {
                    validityText = `Valid for ${diffHours} more hour${diffHours === 1 ? '' : 's'}`;
                } else if (diffDays < 7) {
                    validityText = `Valid for ${diffDays} more day${diffDays === 1 ? '' : 's'}`;
                } else if (diffDays < 365) {
                    validityText = `Valid until ${validUntil.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                } else {
                    validityText = 'Lifetime access granted';
                }
                document.getElementById('validityPeriod').textContent = validityText;
            } else {
                document.getElementById('validityPeriod').textContent = 'Lifetime access granted';
            }

            // Permissions badges with enhanced design
            const permsContainer = document.getElementById('permissionsDisplay');
            const perms = data.perms || [];
            permsContainer.innerHTML = perms.map(p => `
                <span class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-amber-900/15 border border-amber-700/30 text-amber-800 text-sm font-medium">
                    ${p === 'gate' ? `
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/>
                        </svg>
                        Gate Access
                    ` : ''}
                    ${p === 'garage' ? `
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                        </svg>
                        Garage Access
                    ` : ''}
                </span>
            `).join('');

            // Setup buttons based on permissions
            const gateBtn = document.getElementById('gateBtn');
            const garageBtn = document.getElementById('garageBtn');

            if (perms.includes('gate')) {
                gateBtn.style.display = 'flex';
                gateBtn.onclick = () => executeAction('gate');
            }

            if (perms.includes('garage')) {
                garageBtn.style.display = 'flex';
                garageBtn.onclick = () => executeAction('garage');
            }
        }

        function showInvalid(reason) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('invalidState').classList.remove('hidden');
            document.getElementById('invalidReason').textContent = reason;
        }

        // Activity logging
        const ACTIVITY_STORAGE_KEY = 'residence_pass_activity';

        function logActivity(entry) {
            try {
                const data = localStorage.getItem(ACTIVITY_STORAGE_KEY);
                const log = data ? JSON.parse(data) : [];
                log.push({
                    id: `act_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                    passId: entry.passId,
                    guestName: entry.guestName,
                    action: entry.action,
                    success: entry.success,
                    timestamp: Date.now(),
                    userAgent: navigator.userAgent.substring(0, 100)
                });
                // Keep only last 500 entries
                const trimmed = log.slice(-500);
                localStorage.setItem(ACTIVITY_STORAGE_KEY, JSON.stringify(trimmed));
            } catch (e) {
                console.warn('Failed to log activity:', e);
            }
        }

        async function executeAction(action) {
            const btn = document.getElementById(action + 'Btn');
            const statusEl = document.getElementById(action + 'Status');

            // Show loading state
            btn.classList.add('loading');
            statusEl.innerHTML = '<div class="loading-spinner"></div>';

            let success = false;

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: action,
                        passId: passData.id,
                        guestName: passData.name,
                        timestamp: Date.now()
                    })
                });

                if (response.ok) {
                    success = true;
                    // Success!
                    btn.classList.add('success', 'success-pulse');
                    statusEl.innerHTML = `
                        <svg class="w-7 h-7 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
                        </svg>
                    `;

                    // Vibrate on success (if supported)
                    if (navigator.vibrate) {
                        navigator.vibrate([100, 50, 100]);
                    }

                    // Reset after delay
                    setTimeout(() => {
                        btn.classList.remove('success', 'success-pulse');
                        statusEl.innerHTML = `
                            <svg class="w-6 h-6 text-white/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        `;
                    }, 4000);
                } else {
                    throw new Error('Server error');
                }
            } catch (e) {
                console.error('Action failed:', e);
                // Show error state
                statusEl.innerHTML = `
                    <svg class="w-7 h-7 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                `;

                setTimeout(() => {
                    statusEl.innerHTML = `
                        <svg class="w-6 h-6 text-white/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    `;
                }, 2500);
            }

            // Log activity regardless of success/failure
            logActivity({
                passId: passData.id,
                guestName: passData.name,
                action: action,
                success: success
            });

            btn.classList.remove('loading');
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
